---
slug: create-credit-card
layout_name: ''
authorization_policies:
---

{% parse_json "properties" %}
  {
    "customer_id": "100",
    "external_customer_id": "101",
    "customer_email": "example@platform-os.com",
    "metadata": "{{ context.params.metadata | json }}"
  }
{% endparse_json %}
{% assign expires_in = 'now' | date: '%s' | plus: 100000 %}


{%- assign external_id = params.properties_attributes.external_customer_id %}
{%- 
  query_graph 'modules/payments/get_customer_by_external_id',
    result_name: 'g_customer',
    external_id: external_id
-%}
{%- assign customer = g_customer.customizations.results.first -%}

{% if customer %}
  {%
    include_form 'modules/payments/create_credit_card_form',
      customer_id: customer.id
      properties: properties,
      redirect_to: 'create-credit-card',
      expires_in: expires_in
  %}
{% else %}
  {%
    include_form 'modules/payments/create_customer_form',
      properties: properties,
      redirect_to: 'create-credit-card',
      expires_in: expires_in
  %}
{% endif %}
