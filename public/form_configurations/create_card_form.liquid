---
name: create_card_form
resource: modules/payments/credit_card
resource_owner: anyone
redirect_to: "{{ context.params.redirect_to }}"
fields:
  customizable_type:
  customizable_id:
  properties:
    customer_email:
      property_options:
        virtual: true
    token:
      property_options:
        virtual: true
    metadata:
      property_options:
        virtual: true
    stripe_customer_id:
      validation:
        presence: true
    customer_id:
      validation:
        presence: true
    external_customer_id:
      validation:
        presence: true
    stripe_id:
      validation:
        presence: true
    brand:
      validation:
        presence: true
    exp_month:
      validation:
        presence: true
    exp_year:
      validation:
        presence: true
    last4:
      validation:
        presence: true
callback_actions:
default_payload: >
  {% if form %}
    {%- assign external_id = params.properties_attributes.external_customer_id %}
    {%- query_graph 'modules/payments/get_customer_by_external_id', result_name: 'g_customer', external_id: external_id -%}
    {%- assign stripe_customer_id = g_customer.customizations.results.first.stripe_id %}
    {% if stripe_customer_id != blank %}
      {% parse_json cc_data %}
        {
          "customer_id": "{{ stripe_customer_id }}",
          "source": "{{ form.properties.token | default: params.properties_attributes.token }}"
        }
      {% endparse_json %}

      {%- log cc_data, type: "cc_data" -%}
      {%- assign gateway_template = "modules/payments/stripe/create_card" %}
      {%- execute_query 'modules/payments/gateway_create_card', result_name: 'g', data: cc_data, gateway_template: gateway_template -%}
      {%- assign response_body = g.api_call_send.response.body | to_hash %}
      {
        "customizable_type": "Customization",
        "customizable_id": "{{ response_body.id }}",
        "user_id": "{{ context.current_user.id }}",
        "properties_attributes": {
          "stripe_customer_id": "{{ stripe_customer_id }}",
          "external_customer_id": "{{ external_id }}",
          "stripe_id": "{{ response_body.id }}",
          "brand": "{{ response_body.brand }}",
          "exp_month": "{{ response_body.exp_month }}",
          "exp_year": "{{ response_body.exp_year }}",
          "last4": "{{ response_body.last4 }}",
          "customer_id": "{{ g_customer.customizations.results.first.id }}"
        }
      }
    {% else %}
      {%- assign email = form.properties.customer_email | default: params.customer_email -%}
      {%- assign token = form.properties.token | default: params.properties_attributes.token -%}
      {%- execute_query 'modules/payments/create_customer', result_name: 'g_customer',
        email: email,
        external_id: external_id,
        source: token,
        skip_credit_card_creation: "true"
      -%}
      {
        "customizable_type": "Customization",
        "customizable_id": "{{ g_customer.id }}",
        "user_id": "{{ context.current_user.id }}",
        "properties_attributes": {
          "stripe_customer_id": "{{ g_customer.customer.properties.stripe_id }}",
          "external_customer_id": "{{ external_id }}",
          "stripe_id": "{{ g_customer.customer.properties.default_source }}",
          "brand": "{{ g_customer.customer.properties.card_brand }}",
          "exp_month": "{{ g_customer.customer.properties.card_exp_month }}",
          "exp_year": "{{ g_customer.customer.properties.card_exp_year }}",
          "last4": "{{ g_customer.customer.properties.card_last4 }}",
          "customer_id": "{{ g_customer.customer.id }}"
        }
      }
    {% endif %}
  {% endif %}
authorization_policies:
  - modules/payments/validate_signature
---
<script src="https://checkout.stripe.com/checkout.js" defer></script>
<script src="{{ 'CheckoutPaymentForm.js' | asset_url }}" defer></script>

{%- include 'modules/payments/shared/api_credentials' -%}
{%- capture "signature" -%}
  {% include 'modules/payments/shared/calculate_signature', properties: properties, expires_in: expires_in, redirect_to: redirect_to %}
{%- endcapture -%}

{% form %}
  <input type="text" name="signature" value="{{ signature }}" />
  <input type="text" name="redirect_to" value="{{ redirect_to }}" />
  <input type="text" name="expires_in" value="{{ expires_in }}" />

  {% for property in properties %}
    <input type="text" name="{{ form_builder.fields.properties[property.first]['name'] }}" value="{{ property.last }}" />
  {% endfor %}
  <input type="text" name="{{ form_builder.fields.properties.token.name }}" value="" data-cc-token />
  {% include 'modules/payments/card/form' %}

{% endform %}
