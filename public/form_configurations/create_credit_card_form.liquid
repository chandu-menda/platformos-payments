---
name: create_credit_card_form
resource: modules/payments/credit_card
resource_owner: anyone
redirect_to: "{{ context.params.redirect_to }}"
fields:
  customizable_type:
  customizable_id:
  properties:
    customer_email:
      property_options:
        virtual: true
    token:
      property_options:
        virtual: true
    metadata:
      property_options:
        virtual: true
    gateway_customer_id:
      validation:
        presence: true
    customer_id:
      validation:
        presence: true
    external_customer_id:
      validation:
        presence: true
    gateway_id:
      validation:
        presence: true
    brand:
      validation:
        presence: true
    exp_month:
      validation:
        presence: true
    exp_year:
      validation:
        presence: true
    last4:
      validation:
        presence: true
callback_actions:
default_payload: >
  {% if form %}

    {% if customer.id != blank %}
      {% parse_json cc_data %}
        {
          "customer_id": "{{ customer.gateway_id }}",
          "source": "{{ form.properties.token | default: params.properties_attributes.token }}"
        }
      {% endparse_json %}

      {%- assign gateway_template = "modules/payments/stripe/create_card" -%}
      {%- execute_query 'modules/payments/gateway_create_card', result_name: 'g', data: cc_data, gateway_template: gateway_template -%}
      {%- assign credit_card = g.api_call_send.response.body | to_hash %}
      
    {% else %}
      {%- assign email = form.properties.customer_email | default: params.customer_email -%}
      {%- assign token = form.properties.token | default: params.properties_attributes.token -%}
      {% parse_json "customer" %}
        {% 
          include 'modules/payments/gateway/create_customer',
            email: email,
            token: token,
            external_id: external_id 
        %}
      {% endparse_json %}
      
      {%- assign credit_card = customer.credit_card %}
    {% endif %}

    {
      "customizable_type": "Customization",
      "customizable_id": "{{ customer.id }}",
      "user_id": "{{ context.current_user.id }}",
      "properties_attributes": {
        "gateway_customer_id": "{{ customer.gateway_id }}",
        "external_customer_id": "{{ external_id }}",
        "gateway_id": "{{ credit_card.id }}",
        "brand": "{{ credit_card.brand }}",
        "exp_month": "{{ credit_card.exp_month }}",
        "exp_year": "{{ credit_card.exp_year }}",
        "last4": "{{ credit_card.last4 }}",
        "customer_id": "{{ customer.id }}"
      }
    }
  {% endif %}
authorization_policies:
  - modules/payments/validate_signature
---
<script src="https://checkout.stripe.com/checkout.js" defer></script>
<script src="{{ 'modules/payments/javascripts/CheckoutPaymentForm.js' | asset_url }}" defer></script>

{%- include 'modules/payments/shared/api_credentials' -%}
{%- capture "signature" -%}
  {% include 'modules/payments/shared/calculate_signature', properties: properties, expires_in: expires_in, redirect_to: redirect_to %}
{%- endcapture -%}

{% form %}
  <input type="text" name="signature" value="{{ signature }}" />
  <input type="text" name="redirect_to" value="{{ redirect_to }}" />
  <input type="text" name="expires_in" value="{{ expires_in }}" />

  {% for property in properties %}
    <input type="text" name="{{ form_builder.fields.properties[property.first]['name'] }}" value="{{ property.last }}" />
  {% endfor %}
  <input type="text" name="{{ form_builder.fields.properties.token.name }}" value="" data-cc-token />
  {% include 'modules/payments/card/form' %}
{% endform %}

